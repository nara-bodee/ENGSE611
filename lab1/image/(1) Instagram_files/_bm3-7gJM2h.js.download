;/*FB_PKG_DELIM*/

__d("FileMercuryUploadService",["FBLogger","asyncToGeneratorRuntime","cr:6057","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.onUploadStart,o=e.onUploadProgress,a=o===void 0?r("emptyFunction"):o,i=e.onUploadSuccess,l=i===void 0?r("emptyFunction"):i,s=e.onUploadFailure,c=s===void 0?r("emptyFunction"):s,d=e.isVoiceClip,m=d===void 0?!1:d,p=e.files,_=e.uploadIDs,f=e.isChatSupportUser,g=e.chatSupportUserId,h=e.voiceClipWaveformData,y=e.chatSupportUserNonce,C=e.uploadIdToQplFlow,b="/ajax/mercury/upload.php";f===!0&&(b="/ajax/mercury/chatsupportuser/upload.php");var v=yield n("cr:6057").load(),S=new v({concurrentLimit:3,onUploadFailure:c,onUploadProgress:a,onUploadStart:function(n,r){t&&t(n,r.upload._file.size,r.upload._file.type)},onUploadSuccess:function(t,n){var e,o,a,i,s=C==null?void 0:C.get(t),c=n.response.payload.metadata,d;if(c==null)r("FBLogger")("messenger_web_media").warn("Empty payload"),d={},s==null||s.endFail("empty_payload");else{var m=c[0];m!=null?d=m:(r("FBLogger")("messenger_web_media").warn("Empty metadata isChatSupportUser: %s",f),d={},s==null||s.endFail("empty_metadata"))}var p=d.fbid,_=d.image_id,g=d.video_id,h=d.audio_id,y=d.gif_id,b=d.file_id,v=(e=(o=(a=(i=p!=null?p:_)!=null?i:g)!=null?a:h)!=null?o:y)!=null?e:b;if(typeof v=="number"&&(v=v.toString()),u(v),l(t,v),v==null)throw s==null||s.endFail("null_fbid"),r("FBLogger")("messenger_web").mustfixThrow("Unrecognized file upload success payload");s==null||s.endSuccess()},retryLimit:1,uploadEndpoint:b}),R=h!=null?{amplitudes:h.amplitudes,sampling_freq:Math.round(h.sampling_freq)}:void 0,L={};L.data={chat_support_user_id:f===!0&&g!=null?g:void 0,nonce:f===!0&&y!=null?y:void 0,voice_clip:m?!0:void 0,voice_clip_waveform_data:m?JSON.stringify(R):void 0},S.getAsyncFileUploadRequest(p,_,L).send()}),s.apply(this,arguments)}function u(e){if(e!=null){var t=Number(e),n=t.toString();t>Number.MAX_SAFE_INTEGER&&n!==e&&r("FBLogger")("work_web_messaging","messaging-composer-upload-fbid-out-of-range").warn("FBID for attachment is out of JS Number range and it's not correctly handled on client: %d",e)}}l.uploadByMercuryUploadService=e}),98);
__d("LSGenerateTraceId",["LSRequestId","MetaConfig"],(function(t,n,r,o,a,i,l){"use strict";function e(){if(r("MetaConfig")._("62"))return r("LSRequestId").generate()}l.default=e}),98);
__d("LSGetLocalizedReplySnippet",["LSGetThreadParticipantDisplayName","LSGetViewerFBID","LSLocalize"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(e){return t.storedProcedure(n("LSGetViewerFBID")).then(function(e){var t;return t=e,r[0]=t[0],t})},function(o){return t.i64.eq(e[3],t.i64.cast([0,1]))?t.sequence([function(o){return t.i64.eq(e[1],r[0])?t.sequence([function(o){return t.i64.eq(e[2],r[0])?t.sequence([function(e){return n("LSLocalize").localizeV2Async(t.i64.cast([0,2421884758]),void 0).then(function(e){return r[4]=e})},function(e){return r[3]=r[4]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[2]).then(function(e){var t;return t=e,r[4]=t[0],t})},function(e){return r[5]=t.createArray(),r[7]=(r[5].push(r[4]),r[5]),n("LSLocalize").localizeV2Async(t.i64.cast([0,2676961947]),r[5]).then(function(e){return r[6]=e})},function(e){return r[3]=r[6]}])},function(e){return r[2]=r[3]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[1]).then(function(e){var t;return t=e,r[3]=t[0],t})},function(o){return t.i64.eq(e[2],r[0])?t.sequence([function(e){return r[5]=t.createArray(),r[7]=(r[5].push(r[3]),r[5]),n("LSLocalize").localizeV2Async(t.i64.cast([0,3298086032]),r[5]).then(function(e){return r[6]=e})},function(e){return r[4]=r[6]}]):t.sequence([function(o){return t.i64.eq(e[1],e[2])?t.sequence([function(e){return r[6]=t.createArray(),r[8]=(r[6].push(r[3]),r[6]),n("LSLocalize").localizeV2Async(t.i64.cast([0,3873263038]),r[6]).then(function(e){return r[7]=e})},function(e){return r[5]=r[7]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[2]).then(function(e){var t;return t=e,r[6]=t[0],t})},function(e){return r[7]=t.createArray(),r[9]=(r[7].push(r[3]),r[7]),r[9]=(r[7].push(r[6]),r[7]),n("LSLocalize").localizeV2Async(t.i64.cast([0,2616853333]),r[7]).then(function(e){return r[8]=e})},function(e){return r[5]=r[8]}])},function(e){return r[4]=r[5]}])},function(e){return r[2]=r[4]}])},function(e){return r[1]=r[2]}]):t.sequence([function(o){return t.i64.eq(e[1],r[0])?t.sequence([function(o){return t.i64.eq(e[2],r[0])?t.sequence([function(e){return n("LSLocalize").localizeV2Async(t.i64.cast([0,4002265907]),void 0).then(function(e){return r[4]=e})},function(e){return r[3]=r[4]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[2]).then(function(e){var t;return t=e,r[4]=t[0],t})},function(e){return r[5]=t.createArray(),r[7]=(r[5].push(r[4]),r[5]),n("LSLocalize").localizeV2Async(t.i64.cast([0,2663996736]),r[5]).then(function(e){return r[6]=e})},function(e){return r[3]=r[6]}])},function(e){return r[2]=r[3]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[1]).then(function(e){var t;return t=e,r[3]=t[0],t})},function(o){return t.i64.eq(e[2],r[0])?t.sequence([function(e){return r[5]=t.createArray(),r[7]=(r[5].push(r[3]),r[5]),n("LSLocalize").localizeV2Async(t.i64.cast([0,2868699317]),r[5]).then(function(e){return r[6]=e})},function(e){return r[4]=r[6]}]):t.sequence([function(o){return t.i64.eq(e[1],e[2])?t.sequence([function(e){return r[6]=t.createArray(),r[8]=(r[6].push(r[3]),r[6]),n("LSLocalize").localizeV2Async(t.i64.cast([0,2688620547]),r[6]).then(function(e){return r[7]=e})},function(e){return r[5]=r[7]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[2]).then(function(e){var t;return t=e,r[6]=t[0],t})},function(e){return r[7]=t.createArray(),r[9]=(r[7].push(r[3]),r[7]),r[9]=(r[7].push(r[6]),r[7]),n("LSLocalize").localizeV2Async(t.i64.cast([0,3544071775]),r[7]).then(function(e){return r[8]=e})},function(e){return r[5]=r[8]}])},function(e){return r[4]=r[5]}])},function(e){return r[2]=r[4]}])},function(e){return r[1]=r[2]}])},function(e){return o[0]=r[1]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxGetLocalizedReplySnippetStoredProcedure",e.__tables__=[],a.exports=e}),null);
__d("LSGetMessageAttributionParams",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(o){return t.sequence([function(r){return t.filter(t.db.table(31).fetch(),function(t){return t.offlineThreadingId===e[0]}).next().then(function(e,t){var r,o,a=e.done,i=e.value;return a?(r=[void 0,void 0,void 0],n[0]=r[0],n[1]=r[1],n[2]=r[2],r):(t=i.item,o=[t.threadAttributionSource,t.platformRef,t.platformToken],n[0]=o[0],n[1]=o[1],n[2]=o[2])})},function(e){var t;return t=[n[0],n[1],n[2]],r[0]=t[0],r[1]=t[1],r[2]=t[2],t}])},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMediaSendGetMessageAttributionParamsStoredProcedure",e.__tables__=["messages_optimistic_context"],a.exports=e}),null);
__d("LSInsertPhase2PendingTask",["LSIssueNewTask"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return t.db.table(12).fetch([[[e[0]]],"optimistic"]).next().then(function(e,t){var n=e.done,o=e.value;return n?r[0]=void 0:(t=o.item,r[0]=t.threadKey)})},function(o){return t.i64.neq(r[0],void 0)?t.sequence([function(o){return t.storedProcedure(n("LSIssueNewTask"),[t.i64.to_string(r[0]),"_multi_media"].join(""),t.i64.cast([0,4]),e[0],void 0,void 0,e[1],t.i64.cast([0,0]),t.i64.cast([0,29]),void 0,t.i64.cast([0,0]),t.i64.cast([0,0]))},function(e){return r[2]=void 0}]):t.resolve(r[2]=t.i64.cast([0,1002]))},function(e){return o[0]=r[2]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMediaSendInsertPhase2PendingTaskStoredProcedure",e.__tables__=["messages"],a.exports=e}),null);
__d("LSIssueNewTaskWithExtraOperationsAndGetTaskID",["LSIssueNewTaskAndGetTaskID","LSMailboxTaskCompletionApiOnTaskInsertion"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(o){return t.storedProcedure(n("LSIssueNewTaskAndGetTaskID"),e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[11]).then(function(e){var t;return t=e,r[0]=t[0],t})},function(e){return t.storedProcedure(n("LSMailboxTaskCompletionApiOnTaskInsertion"),r[0])},function(e){return o[0]=r[0]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSCoreIssueNewTaskWithExtraOperationsAndGetTaskIDStoredProcedure",e.__tables__=[],a.exports=e}),null);
__d("LSPredefineTraceForTask",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(r){return t.sequence([function(r){return n[0]=t.i64.of_float(Date.now()),t.forEach(t.db.table(2).fetch([[[e[1]]]]),function(t){var r=t.update,o=t.item;return r({dataTraceId:e[0],initTraceTimestampMs:n[0]})})},function(r){return t.db.table(153).add({traceId:e[0],initTimestampMs:n[0],foregroundTimestampMs:t.i64.cast([0,0]),traceType:t.i64.cast([0,1]),shouldFlush:!1,contextOne:e[2],contextTwo:t.i64.to_string(e[1]),predefinedId:e[3]})}])},function(e){return t.resolve(r)}])}e.__sproc_name__="LSDataTracePredefineTraceForTaskStoredProcedure",e.__tables__=["pending_tasks","data_trace_meta"],a.exports=e}),null);
__d("LSIssueSendAttachmentMessageTask",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIssueNewTaskWithExtraOperationsAndGetTaskID","LSPredefineTraceForTask"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(o){return r[0]=t.i64.of_int32(e[5].length),t.i64.gt(r[0],t.i64.cast([0,0]))?t.loopAsync(r[0],function(o){return r[7]=o,t.sequence([function(o){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),e[5],r[7]).then(function(e){var t;return t=e,r[8]=t[0],r[9]=t[1],t})},function(n){return t.forEach(t.filter(t.db.table(16).fetch([[[e[1],e[3]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&n.messageId===e[3]&&t.i64.eq(n.attachmentIndex,r[7])&&t.i64.eq(n.authorityLevel,t.i64.cast([0,20]))}),function(e){var n=e.update,o=e.item;return n({attachmentFbid:t.i64.to_string(r[8])})})}])}):t.resolve()},function(n){return e[9]?r[1]=t.i64.cast([0,9]):r[1]=t.i64.cast([0,3]),t.db.table(9).fetch([[[e[1]]]]).next().then(function(e,n){var o=e.done,a=e.value;return o?r[2]=t.i64.cast([0,1]):(n=a.item,r[8]=n.syncGroup,t.i64.neq(r[8],void 0)?r[7]=r[8]:r[7]=t.i64.cast([0,1]),r[2]=r[7])})},function(o){return t.storedProcedure(n("LSIssueNewTaskWithExtraOperationsAndGetTaskID"),t.i64.to_string(e[1]),t.i64.cast([0,46]),"",void 0,void 0,t.i64.cast([0,0]),t.i64.cast([0,0]),r[2],void 0,t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,r[4]=t[0],t})},function(o){return e[12]!==void 0?t.sequence([function(o){return t.storedProcedure(n("LSPredefineTraceForTask"),e[12],r[4],t.i64.to_string(t.i64.cast([0,46])),e[3])},function(r){return t.storedProcedure(n("LSAppendDataTraceAddon"),e[12],t.i64.cast([0,20]),t.i64.cast([0,1]),void 0,void 0)}]):t.resolve()},function(n){return r[5]=new t.Map,r[6]=t.createArray(),t.db.table(31).add({taskId:r[4],threadKey:e[1],offlineThreadingId:e[3],threadAttributionSource:e[6],platformRef:e[10],platformToken:e[11],replySourceId:e[7],replySourceType:e[8],sendType:r[1],markThreadRead:!1,metadataDataclass:e[13]})}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxIssueSendAttachmentMessageTaskStoredProcedure",e.__tables__=["attachments","threads","messages_optimistic_context"],a.exports=e}),null);
__d("LSSetMessageViewFlags",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(r){return t.sequence([function(r){return t.filter(t.db.table(12).fetch([[[e[0],e[2],e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[0])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(n.timestampMs,e[2])&&n.messageId===e[1]}).next().then(function(e,r){var o,a,i=e.done,l=e.value;return i?(o=[t.i64.cast([0,0]),t.i64.cast([0,0]),t.i64.cast([0,0]),!1,"nonexistent",t.i64.cast([0,20]),void 0,t.i64.cast([-1,4294967295]),t.i64.cast([-1,4294967295])],n[0]=o[0],n[1]=o[1],n[2]=o[2],n[3]=o[3],n[4]=o[4],n[5]=o[5],n[6]=o[6],n[7]=o[7],n[8]=o[8],o):(r=l.item,a=[r.timestampMs,r.senderId,r.viewFlags,r.isAdminMessage,r.messageId,r.authorityLevel,r.stickerId,r.primarySortKey,r.secondarySortKey==null?t.i64.cast([-1,4294967295]):r.secondarySortKey],n[0]=a[0],n[1]=a[1],n[2]=a[2],n[3]=a[3],n[4]=a[4],n[5]=a[5],n[6]=a[6],n[7]=a[7],n[8]=a[8])})},function(r){return t.sortBy(t.filter(t.db.table(12).fetch([[[e[0],{gt:n[7]}],[e[0],n[7]]],"messageDisplayOrder"]),function(r){return t.i64.eq(r.threadKey,e[0])&&r.messageId!==e[1]&&(t.i64.gt(r.primarySortKey,n[7])||t.i64.eq(r.primarySortKey,n[7])&&t.i64.ge(r.secondarySortKey==null?t.i64.cast([-1,4294967295]):r.secondarySortKey,n[8]))}),[["timestampMs","ASC"]],["primarySortKey","secondarySortKey"]).next().then(function(e,r){var o,a,i=e.done,l=e.value;return i?(o=[t.i64.cast([0,0]),t.i64.cast([0,0]),t.i64.cast([0,0]),!1,"nonexistent",t.i64.cast([0,20]),void 0,t.i64.cast([-1,4294967295]),t.i64.cast([-1,4294967295])],n[10]=o[0],n[11]=o[1],n[12]=o[2],n[13]=o[3],n[14]=o[4],n[15]=o[5],n[16]=o[6],n[17]=o[7],n[18]=o[8],o):(r=l.item,a=[r.timestampMs,r.senderId,r.viewFlags,r.isAdminMessage,r.messageId,r.authorityLevel,r.stickerId,t.i64.cast([-1,4294967295]),t.i64.cast([-1,4294967295])],n[10]=a[0],n[11]=a[1],n[12]=a[2],n[13]=a[3],n[14]=a[4],n[15]=a[5],n[16]=a[6],n[17]=a[7],n[18]=a[8])})},function(r){return t.sortBy(t.filter(t.db.table(12).fetchDesc([[[e[0],{lt:n[7]}],[e[0],n[7]]],"messageDisplayOrder"]),function(r){return t.i64.eq(r.threadKey,e[0])&&r.messageId!==e[1]&&(t.i64.lt(r.primarySortKey,n[7])||t.i64.eq(r.primarySortKey,n[7])&&t.i64.le(r.secondarySortKey==null?t.i64.cast([-1,4294967295]):r.secondarySortKey,n[8]))}),[["timestampMs","DESC"]],["primarySortKey","secondarySortKey"]).next().then(function(e,r){var o,a,i=e.done,l=e.value;return i?(o=[t.i64.cast([0,0]),t.i64.cast([0,0]),t.i64.cast([0,0]),!1,"nonexistent",t.i64.cast([0,20]),void 0,t.i64.cast([-1,4294967295]),t.i64.cast([-1,4294967295])],n[20]=o[0],n[21]=o[1],n[22]=o[2],n[23]=o[3],n[24]=o[4],n[25]=o[5],n[26]=o[6],n[27]=o[7],n[28]=o[8],o):(r=l.item,a=[r.timestampMs,r.senderId,r.viewFlags,r.isAdminMessage,r.messageId,r.authorityLevel,r.stickerId,t.i64.cast([-1,4294967295]),t.i64.cast([-1,4294967295])],n[20]=a[0],n[21]=a[1],n[22]=a[2],n[23]=a[3],n[24]=a[4],n[25]=a[5],n[26]=a[6],n[27]=a[7],n[28]=a[8])})},function(r){return n[32]=t.i64.or_(t.i64.cast([0,2]),t.i64.or_(!n[3]&&!e[3]?t.i64.cast([0,4]):t.i64.cast([0,0]),t.i64.or_(n[3]?t.i64.cast([0,0]):t.i64.cast([0,1]),t.i64.or_(t.i64.eq(n[5],t.i64.cast([0,60]))||t.i64.eq(n[5],t.i64.cast([0,80]))?t.i64.cast([0,1048576]):t.i64.cast([0,0]),t.i64.neq(n[6],t.i64.cast([85970,924785702]))&&t.i64.neq(n[6],t.i64.cast([85970,1004785694]))&&t.i64.neq(n[6],t.i64.cast([85970,1044785690]))?t.i64.cast([0,0]):t.i64.cast([0,2097152]))))),n[14]!=="nonexistent"?t.sequence([function(r){return n[35]=t.i64.or_(t.i64.and_(n[12],t.i64.cast([-1,4294967280])),t.i64.or_(t.i64.gt(t.i64.sub(n[10],n[0]),t.i64.cast([0,6e5]))?t.i64.cast([0,2]):t.i64.cast([0,0]),t.i64.or_(t.i64.eq(n[11],n[1])&&!n[13]&&!n[3]&&!t.i64.gt(t.i64.sub(n[10],n[0]),t.i64.cast([0,6e5]))?t.i64.cast([0,8]):t.i64.cast([0,0]),t.i64.or_(!e[3]&&!n[13]&&!(t.i64.eq(n[11],n[1])&&!n[13]&&!n[3]&&!t.i64.gt(t.i64.sub(n[10],n[0]),t.i64.cast([0,6e5])))?t.i64.cast([0,4]):t.i64.cast([0,0]),t.i64.and_(n[12],t.i64.cast([0,1])))))),n[33]=t.i64.eq(t.i64.and_(n[35],t.i64.cast([0,8])),t.i64.cast([0,8])),n[34]=n[33]?t.i64.or_(n[32],t.i64.cast([0,16])):n[32],t.forEach(t.filter(t.db.table(12).fetch([[[e[0],n[10],n[14]]]]),function(r){return t.i64.eq(r.threadKey,e[0])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(r.timestampMs,n[10])&&r.messageId===n[14]}),function(e){var t=e.update,r=e.item;return t({viewFlags:n[35]})})},function(e){return n[30]=n[33]?t.i64.and_(n[34],t.i64.cast([-1,4294967294])):n[34]}]):t.resolve(n[30]=n[32])},function(r){return n[24]!=="nonexistent"?t.sequence([function(r){return n[35]=t.i64.or_(t.i64.and_(n[30],t.i64.cast([-1,4294967280])),t.i64.or_(t.i64.gt(t.i64.sub(n[0],n[20]),t.i64.cast([0,6e5]))?t.i64.cast([0,2]):t.i64.cast([0,0]),t.i64.or_(t.i64.eq(n[1],n[21])&&!n[3]&&!n[23]&&!t.i64.gt(t.i64.sub(n[0],n[20]),t.i64.cast([0,6e5]))?t.i64.cast([0,8]):t.i64.cast([0,0]),t.i64.or_(!e[3]&&!n[3]&&!(t.i64.eq(n[1],n[21])&&!n[3]&&!n[23]&&!t.i64.gt(t.i64.sub(n[0],n[20]),t.i64.cast([0,6e5])))?t.i64.cast([0,4]):t.i64.cast([0,0]),t.i64.and_(n[30],t.i64.cast([0,1])))))),n[33]=t.i64.eq(t.i64.and_(n[35],t.i64.cast([0,8])),t.i64.cast([0,8])),n[34]=n[33]?t.i64.or_(n[22],t.i64.cast([0,16])):n[22],t.forEach(t.filter(t.db.table(12).fetch([[[e[0],n[20],n[24]]]]),function(r){return t.i64.eq(r.threadKey,e[0])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(r.timestampMs,n[20])&&r.messageId===n[24]}),function(e){var r=e.update,o=e.item;return r({viewFlags:n[33]?t.i64.and_(n[34],t.i64.cast([-1,4294967294])):n[34]})})},function(e){return n[31]=n[35]}]):t.resolve(n[31]=n[30])},function(r){return t.forEach(t.filter(t.db.table(12).fetch([[[e[0],n[0],n[4]]]]),function(r){return t.i64.eq(r.threadKey,e[0])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(r.timestampMs,n[0])&&r.messageId===n[4]}),function(e){var t=e.update,r=e.item;return t({viewFlags:n[31]})})}])},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxSetMessageViewFlagsStoredProcedure",e.__tables__=["messages"],a.exports=e}),null);
__d("LSLocalApplyOptimisticMessage",["LSCreateOfflineThreadingID","LSGetLocalizedReplySnippet","LSIssueNewError","LSLocalize","LSSetMessageDisplayedContentTypes","LSSetMessageViewFlags"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(e){return r[0]=t.i64.of_float(Date.now()),t.sequence([function(e){return t.storedProcedure(n("LSCreateOfflineThreadingID"),r[0]).then(function(e){var t;return t=e,r[9]=t[0],t})},function(e){return r[1]=t.i64.to_string(r[9])}])},function(o){return r[8]=e[4]==null?e[3]:e[4],t.sequence([function(e){return t.islc(t.db.table(9).fetchDesc([[[]],"lastActivityTimestampMs"]),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o=e.done,a=e.value;return o?r[9]=t.i64.cast([-1,4294967295]):(n=a.item,r[9]=n.lastActivityTimestampMs)})},function(o){return r[11]=t.i64.add(r[9],t.i64.cast([0,1])),r[13]=t.i64.gt(r[0],r[11])?r[0]:r[11],t.db.table(9).fetch([[[e[1]]]]).next().then(function(o,a){var i=o.done,l=o.value;return i?t.sequence([function(n){return(function(e){t.logger(e).info(e)})("localApplyOptimisticMessage insert optimistic thread"),t.forEach(t.filter(t.db.table(9).fetch([[[e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&t.i64.lt(n.authorityLevel,t.i64.cast([0,40]))}),function(e){return e.delete()})},function(n){return t.db.table(9).add({threadKey:e[1],mailboxType:t.i64.cast([0,0]),threadType:e[2],clientThreadKey:e[1],folderName:"inbox",parentThreadKey:t.i64.cast([0,0]),lastActivityTimestampMs:r[13],lastReadWatermarkTimestampMs:r[13],snippet:r[8],snippetHasEmoji:e[5]==null?!1:e[5],snippetSenderContactId:e[0],ongoingCallState:t.i64.cast([0,0]),authorityLevel:t.i64.cast([0,40])})},function(n){return t.i64.eq(e[2],t.i64.cast([0,13]))||t.i64.eq(e[2],t.i64.cast([0,7]))||t.i64.eq(e[2],t.i64.cast([0,1]))?t.sequence([function(n){return t.forEach(t.filter(t.db.table(14).fetch([[[e[1],e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(n.contactId,e[1])&&t.i64.lt(n.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(n){return t.db.table(14).add({threadKey:e[1],contactId:e[1],readWatermarkTimestampMs:t.i64.cast([0,0]),deliveredWatermarkTimestampMs:t.i64.cast([0,0]),authorityLevel:t.i64.cast([0,20]),isModerator:!1})}]):t.resolve()},function(e){return t.sortBy(t.db.table(115).fetch(),[["timestampMs","DESC"]]).next().then(function(e,t){var n=e.done,o=e.value;return n?r[14]=!1:(t=o.item,r[14]=t.errorShouldBeShown)})},function(e){return r[14]===!0?t.sequence([function(e){return n("LSLocalize").localizeV2Async(t.i64.cast([0,2285622730]),void 0).then(function(e){return r[16]=e})},function(e){return n("LSLocalize").localizeV2Async(t.i64.cast([0,1919524925]),void 0).then(function(e){return r[17]=e})},function(e){return t.storedProcedure(n("LSIssueNewError"),void 0,t.i64.cast([0,1545093]),r[16],r[17],void 0,void 0)}]):t.resolve()}]):(a=l.item,t.forEach(t.filter(t.db.table(9).fetch([[[e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&t.i64.eq(n.threadType,e[2])}),function(t){var n=t.update,o=t.item;return n({lastActivityTimestampMs:r[13],lastReadWatermarkTimestampMs:r[13],snippet:r[8],snippetHasEmoji:e[5]==null?!1:e[5],snippetSenderContactId:e[0],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,additionalThreadContext:void 0})}))})}])},function(o){return t.sequence([function(n){return t.islc(t.db.table(12).fetchDesc([[[e[1],t.i64.cast([0,80])],[e[1],t.i64.cast([0,60])],[e[1],t.i64.cast([0,40])]],"messageDisplayOrderAuthority"]),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o=e.done,a=e.value;return o?(r[33]=t.i64.of_float(Date.now()),r[9]=r[33]):(n=a.item,r[9]=n.primarySortKey)})},function(o){var a,i,l;return e[8]!==void 0&&(t.i64.eq(e[9],t.i64.cast([0,1]))||t.i64.eq(e[10],t.i64.cast([0,1])))?t.sequence([function(o){return t.filter(t.db.table(12).fetch([[[e[8]==null?"":e[8]]],"messageId"]),function(n){return t.i64.eq(n.threadKey,e[1])&&n.messageId===(e[8]==null?"":e[8])}).next().then(function(o,a){var i,l=o.done,s=o.value;return l?(i=[e[8],void 0,void 0,t.i64.cast([0,0]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[33]=i[0],r[34]=i[1],r[35]=i[2],r[36]=i[3],r[37]=i[4],r[38]=i[5],r[39]=i[6],r[40]=i[7],r[41]=i[8],r[42]=i[9],r[43]=i[10],r[44]=i[11],r[45]=i[12],r[46]=i[13],r[47]=i[14],r[48]=i[15],i):(a=s.item,t.sequence([function(o){var i,l,s;return r[54]=a.senderId,r[53]=a.stickerId,t.i64.neq(r[53],void 0)?(i=[r[53],t.i64.cast([0,4])],r[56]=i[0],r[57]=i[1]):(l=[void 0,void 0],r[56]=l[0],r[57]=l[1]),s=[r[56],r[57]],r[50]=s[0],r[51]=s[1],r[55]=a.replyType==null?t.i64.cast([0,0]):a.replyType,t.sequence([function(o){return t.storedProcedure(n("LSGetLocalizedReplySnippet"),e[1],e[0],r[54],r[55]).then(function(e){var t;return t=e,r[56]=t[0],t})},function(n){return r[52]=t.i64.eq(e[10],t.i64.cast([0,1]))?r[56]:""}])},function(n){var o;return o=[e[8],e[9],e[10],t.i64.cast([0,1]),r[52],r[54],a.text,r[50],r[51],void 0,void 0,void 0,void 0,void 0,void 0,r[55]],r[33]=o[0],r[34]=o[1],r[35]=o[2],r[36]=o[3],r[37]=o[4],r[38]=o[5],r[39]=o[6],r[40]=o[7],r[41]=o[8],r[42]=o[9],r[43]=o[10],r[44]=o[11],r[45]=o[12],r[46]=o[13],r[47]=o[14],r[48]=o[15],o}]))})},function(e){var t;return t=[r[33],r[34],r[35],r[36],r[37],r[38],r[39],r[40],r[41],r[42],r[43],r[44],r[45],r[46],r[47],r[48]],r[11]=t[0],r[12]=t[1],r[13]=t[2],r[14]=t[3],r[15]=t[4],r[16]=t[5],r[17]=t[6],r[18]=t[7],r[19]=t[8],r[20]=t[9],r[21]=t[10],r[22]=t[11],r[23]=t[12],r[24]=t[13],r[25]=t[14],r[26]=t[15],t}]):t.resolve((e[8]===void 0||t.i64.eq(e[9],t.i64.cast([0,0]))||t.i64.eq(e[10],t.i64.cast([0,0]))?(a=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[33]=a[0],r[34]=a[1],r[35]=a[2],r[36]=a[3],r[37]=a[4],r[38]=a[5],r[39]=a[6],r[40]=a[7],r[41]=a[8],r[42]=a[9],r[43]=a[10],r[44]=a[11],r[45]=a[12],r[46]=a[13],r[47]=a[14],r[48]=a[15]):(i=[e[8],e[9],e[10],t.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[33]=i[0],r[34]=i[1],r[35]=i[2],r[36]=i[3],r[37]=i[4],r[38]=i[5],r[39]=i[6],r[40]=i[7],r[41]=i[8],r[42]=i[9],r[43]=i[10],r[44]=i[11],r[45]=i[12],r[46]=i[13],r[47]=i[14],r[48]=i[15]),l=[r[33],r[34],r[35],r[36],r[37],r[38],r[39],r[40],r[41],r[42],r[43],r[44],r[45],r[46],r[47],r[48]],r[11]=l[0],r[12]=l[1],r[13]=l[2],r[14]=l[3],r[15]=l[4],r[16]=l[5],r[17]=l[6],r[18]=l[7],r[19]=l[8],r[20]=l[9],r[21]=l[10],r[22]=l[11],r[23]=l[12],r[24]=l[13],r[25]=l[14],r[26]=l[15]))},function(n){var o,a;return e[13]?r[27]=!1:r[27]=!0,r[27]?(a=[void 0,void 0,void 0,void 0],r[28]=a[0],r[29]=a[1],r[30]=a[2],r[31]=a[3]):(r[33]=e[13].get("mention_offsets"),r[34]=e[13].get("mention_lengths"),r[35]=e[13].get("mention_ids"),r[36]=e[13].get("mention_types"),o=[r[33],r[34],r[35],r[36]],r[28]=o[0],r[29]=o[1],r[30]=o[2],r[31]=o[3]),e[11]?r[32]=t.i64.cast([0,3]):r[32]=r[13],t.i64.eq(t.i64.cast([0,20]),t.i64.cast([0,20]))?t.db.table(12).add({threadKey:e[1],messageId:r[1],timestampMs:r[0],offlineThreadingId:r[1],primarySortKey:r[9],secondarySortKey:r[0],text:e[3],senderId:e[0],stickerId:e[6],hotEmojiSize:e[7],isForwarded:e[11],forwardScore:e[12],isAdminMessage:!1,sendStatus:t.i64.cast([0,1]),sendStatusV2:t.i64.cast([0,1]),authorityLevel:t.i64.cast([0,20]),replySourceId:r[11],replySourceType:r[12],replySourceTypeV2:r[32],replyStatus:r[14],replySnippet:r[15],replyToUserId:r[16],replyMessageText:r[17],replyAttachmentId:r[18],replyAttachmentType:r[19],replyMediaUrl:r[20],replyMediaUrlFallback:r[21],replyMediaPreviewWidth:r[22],replyMediaPreviewHeight:r[23],replyMediaUrlMimeType:r[24],replyType:r[26],mentionOffsets:r[28],mentionLengths:r[29],mentionIds:r[30],mentionTypes:r[31]}):t.sequence([function(e){return t.db.table(12).fetch([[[r[1]]],"optimistic"]).next().then(function(e,t){var n,o,a=e.done,i=e.value;return a?(n=[r[9],r[0],void 0],r[33]=n[0],r[34]=n[1],r[35]=n[2],n):(t=i.item,o=[t.primarySortKey,t.secondarySortKey,t.localDataId],r[33]=o[0],r[34]=o[1],r[35]=o[2])})},function(e){return t.forEach(t.filter(t.db.table(12).fetch([[[r[1]]],"optimistic"]),function(e){return e.offlineThreadingId===r[1]&&t.i64.lt(e.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(n){return t.db.table(12).add({threadKey:e[1],messageId:r[1],timestampMs:r[0],offlineThreadingId:r[1],primarySortKey:r[33],secondarySortKey:r[34],text:e[3],senderId:e[0],stickerId:e[6],hotEmojiSize:e[7],isForwarded:e[11],forwardScore:e[12],isAdminMessage:!1,sendStatus:t.i64.cast([0,1]),sendStatusV2:t.i64.cast([0,1]),authorityLevel:t.i64.cast([0,20]),localDataId:r[35],replySourceId:r[11],replySourceType:r[12],replySourceTypeV2:r[32],replyStatus:r[14],replySnippet:r[15],replyToUserId:r[16],replyMessageText:r[17],replyAttachmentId:r[18],replyAttachmentType:r[19],replyMediaUrl:r[20],replyMediaUrlFallback:r[21],replyMediaPreviewWidth:r[22],replyMediaPreviewHeight:r[23],replyMediaUrlMimeType:r[24],replyType:r[26],mentionOffsets:r[28],mentionLengths:r[29],mentionIds:r[30],mentionTypes:r[31]})}])}])},function(o){return r[2]=t.createArray(),r[3]=(r[2].push("LSMailboxLocalApplyOptimisticMessageStoredProcedure"),r[2]),r[4]=(r[2].push("localApplyOptimisticMessage"),r[2]),r[5]=(r[2].push(e[1]),r[2]),r[6]=(r[2].push(r[1]),r[2]),r[7]=t.toJSON(r[2]),(function(e){t.logger(e).info(e)})(r[7]),e[14]?t.sequence([function(o){return t.storedProcedure(n("LSSetMessageViewFlags"),e[1],r[1],r[0],t.i64.eq(e[2],t.i64.cast([0,1])))},function(o){return t.storedProcedure(n("LSSetMessageDisplayedContentTypes"),e[1],r[1],r[0],e[3],!1,t.i64.neq(e[6],void 0))}]):t.resolve()},function(e){var t;return t=[r[1],r[0]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxLocalApplyOptimisticMessageStoredProcedure",e.__tables__=["threads","participants","user_visible_network_connectivity_error","messages"],a.exports=e}),null);
__d("LSMarkSubJobCompletedV2",["LSArrayGetObjectAt"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(n){return r[0]=t.createArray(),t.db.table(51).fetch([[[e[0]]]]).next().then(function(e,n){var o=e.done,a=e.value;return o?0:(n=a.item,r[3]=new t.Map,r[3].set("offline_attachment_id",n.offlineAttachmentId),r[3].set("offline_threading_id",n.offlineThreadingId),r[3].set("in_message_index",n.inMessageIndex),r[3].set("attachment_type",n.attachmentType),r[3].set("should_transcode",n.shouldTranscode),r[3].set("use_double_phase",n.useDoublePhase),r[3].set("send_by_server",n.sendByServer),r[3].set("is_secure",n.isSecure),r[3].set("state",n.state),r[3].set("fbid",n.fbid),r[3].set("metadata",n.metadata),r[3].set("error",n.error),r[3].set("message_id",n.messageId),r[4]=(r[0].push(r[3]),r[0]))})},function(o){return r[2]=t.i64.of_int32(r[0].length),t.i64.neq(r[2],t.i64.cast([0,0]))?t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[0],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[3]=t[0],r[4]=t[1],t})},function(n){return r[5]=r[3].get("state"),t.i64.neq(e[1],void 0)?e[2]!==void 0?(t.i64.eq(r[5],t.i64.cast([-1,4294967293]))?(r[7]=t.i64.cast([-1,4294967295]),r[6]=r[7]):(t.i64.eq(r[5],t.i64.cast([0,1]))?r[7]=t.i64.cast([0,2]):(t.i64.eq(r[5],t.i64.cast([0,3]))?r[8]=t.i64.cast([0,4]):(t.i64.eq(r[5],t.i64.cast([0,5]))?r[9]=t.i64.cast([0,6]):(t.i64.eq(r[5],t.i64.cast([0,13]))?r[10]=t.i64.cast([0,14]):(t.i64.eq(r[5],t.i64.cast([0,7]))?r[11]=t.i64.cast([0,8]):(t.i64.eq(r[5],t.i64.cast([0,9]))?r[12]=t.i64.cast([0,10]):(t.i64.eq(r[5],t.i64.cast([0,11]))?r[13]=t.i64.cast([0,12]):r[13]=r[5],r[12]=r[13]),r[11]=r[12]),r[10]=r[11]),r[9]=r[10]),r[8]=r[9]),r[7]=r[8]),r[6]=r[7]),t.forEach(t.db.table(51).fetch([[[e[0]]]]),function(t){var n=t.update,o=t.item;return n({state:r[6],fbid:e[1],messageId:e[2],metadata:e[3]})})):(t.i64.eq(r[5],t.i64.cast([-1,4294967293]))?(r[7]=t.i64.cast([-1,4294967295]),r[6]=r[7]):(t.i64.eq(r[5],t.i64.cast([0,1]))?r[7]=t.i64.cast([0,2]):(t.i64.eq(r[5],t.i64.cast([0,3]))?r[8]=t.i64.cast([0,4]):(t.i64.eq(r[5],t.i64.cast([0,5]))?r[9]=t.i64.cast([0,6]):(t.i64.eq(r[5],t.i64.cast([0,13]))?r[10]=t.i64.cast([0,14]):(t.i64.eq(r[5],t.i64.cast([0,7]))?r[11]=t.i64.cast([0,8]):(t.i64.eq(r[5],t.i64.cast([0,9]))?r[12]=t.i64.cast([0,10]):(t.i64.eq(r[5],t.i64.cast([0,11]))?r[13]=t.i64.cast([0,12]):r[13]=r[5],r[12]=r[13]),r[11]=r[12]),r[10]=r[11]),r[9]=r[10]),r[8]=r[9]),r[7]=r[8]),r[6]=r[7]),t.forEach(t.db.table(51).fetch([[[e[0]]]]),function(t){var n=t.update,o=t.item;return n({state:r[6],fbid:e[1],metadata:e[3]})})):t.i64.neq(e[4],void 0)?(t.i64.eq(r[5],t.i64.cast([-1,4294967293]))?(r[7]=t.i64.cast([-1,4294967295]),r[6]=r[7]):(t.i64.eq(r[5],t.i64.cast([0,1]))?r[7]=t.i64.cast([0,2]):(t.i64.eq(r[5],t.i64.cast([0,3]))?r[8]=t.i64.cast([0,4]):(t.i64.eq(r[5],t.i64.cast([0,5]))?r[9]=t.i64.cast([0,6]):(t.i64.eq(r[5],t.i64.cast([0,13]))?r[10]=t.i64.cast([0,14]):(t.i64.eq(r[5],t.i64.cast([0,7]))?r[11]=t.i64.cast([0,8]):(t.i64.eq(r[5],t.i64.cast([0,9]))?r[12]=t.i64.cast([0,10]):(t.i64.eq(r[5],t.i64.cast([0,11]))?r[13]=t.i64.cast([0,12]):r[13]=r[5],r[12]=r[13]),r[11]=r[12]),r[10]=r[11]),r[9]=r[10]),r[8]=r[9]),r[7]=r[8]),r[6]=r[7]),t.forEach(t.db.table(51).fetch([[[e[0]]]]),function(t){var n=t.update,o=t.item;return n({state:r[6],error:e[4]})})):(t.i64.eq(r[5],t.i64.cast([-1,4294967293]))?(r[7]=t.i64.cast([-1,4294967295]),r[6]=r[7]):(t.i64.eq(r[5],t.i64.cast([0,1]))?r[7]=t.i64.cast([0,2]):(t.i64.eq(r[5],t.i64.cast([0,3]))?r[8]=t.i64.cast([0,4]):(t.i64.eq(r[5],t.i64.cast([0,5]))?r[9]=t.i64.cast([0,6]):(t.i64.eq(r[5],t.i64.cast([0,13]))?r[10]=t.i64.cast([0,14]):(t.i64.eq(r[5],t.i64.cast([0,7]))?r[11]=t.i64.cast([0,8]):(t.i64.eq(r[5],t.i64.cast([0,9]))?r[12]=t.i64.cast([0,10]):(t.i64.eq(r[5],t.i64.cast([0,11]))?r[13]=t.i64.cast([0,12]):r[13]=r[5],r[12]=r[13]),r[11]=r[12]),r[10]=r[11]),r[9]=r[10]),r[8]=r[9]),r[7]=r[8]),r[6]=r[7]),t.forEach(t.db.table(51).fetch([[[e[0]]]]),function(e){var t=e.update,n=e.item;return t({state:r[6]})}))}]):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMediaSendMarkSubJobCompletedV2StoredProcedure",e.__tables__=["media_send_jobs"],a.exports=e}),null);
__d("LSMarkSubJobCompletedV2StoredProcedure",["LSMarkSubJobCompletedV2","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSMarkSubJobCompletedV2"),a.offlineAttachmentId,a.fbid,a.messageId,a.metadata,a.error);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSRemoveMediaSendJobs",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){return e.delete()})},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMediaSendRemoveMediaSendJobsStoredProcedure",e.__tables__=["media_send_jobs"],a.exports=e}),null);
__d("LSRemoveMediaSendJobsStoredProcedure",["LSRemoveMediaSendJobs","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSRemoveMediaSendJobs"),a.offlineThreadingId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSSendPhase1MultiPhotoMessageV2",["LSArrayGetObjectAt","LSGetMessageAttributionParams","LSIssueSendAttachmentMessageTask"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.createArray(),r[1]=new t.Map,r[2]=new t.Map,r[3]=!1,r[4]=t.i64.cast([0,0]),t.forEach(t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["inMessageIndex","ASC"]]),function(e){var n=e.item;return r[7]=n.fbid,r[4]=t.i64.add(r[4],t.i64.cast([0,1])),t.i64.neq(r[7],void 0)?r[8]=(r[0].push(r[7]),r[0]):0})},function(o){return r[5]=t.i64.of_int32(r[0].length),t.i64.neq(r[5],r[4])||t.i64.eq(r[4],t.i64.cast([0,0]))?t.resolve(r[6]=t.i64.cast([0,10002])):t.sequence([function(n){return t.db.table(12).fetch([[[e[0]]],"optimistic"]).next().then(function(e,t){var n,o,a=e.done,i=e.value;return a?(n=[void 0,void 0,void 0,void 0,void 0],r[7]=n[0],r[8]=n[1],r[9]=n[2],r[10]=n[3],r[11]=n[4],n):(t=i.item,o=[t.threadKey,t.senderId,t.text,t.replySourceId,t.replySourceTypeV2],r[7]=o[0],r[8]=o[1],r[9]=o[2],r[10]=o[3],r[11]=o[4])})},function(o){return t.i64.eq(r[7],void 0)||t.i64.eq(r[8],void 0)?t.resolve((t.i64.eq(r[7],void 0)?r[14]=t.i64.cast([0,10003]):r[14]=t.i64.cast([0,10004]),r[13]=r[14])):t.sequence([function(e){return t.db.table(9).fetch([[[r[7]]]]).next().then(function(e,t){var n=e.done,o=e.value;return n?r[14]=void 0:(t=o.item,r[14]=t.threadType)})},function(n){return t.filter(t.db.table(31).fetch(),function(t){return t.offlineThreadingId===e[0]}).next().then(function(e,t){var n,o,a=e.done,i=e.value;return a?(n=[void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[16]=n[0],r[17]=n[1],r[18]=n[2],r[19]=n[3],r[20]=n[4],r[21]=n[5],r[22]=n[6],n):(t=i.item,o=[t.platformRef,t.platformToken,t.initiatingSource,void 0,void 0,t.dataclassParams,t.metadataDataclass],r[16]=o[0],r[17]=o[1],r[18]=o[2],r[19]=o[3],r[20]=o[4],r[21]=o[5],r[22]=o[6])})},function(o){return t.i64.neq(r[14],void 0)?t.sequence([function(o){return r[25]=r[1].keys(),r[26]=t.i64.of_int32(r[25].length),t.i64.gt(r[26],t.i64.cast([0,0]))?t.loopAsync(r[26],function(o){return r[32]=o,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[25],r[32]).then(function(e){var t;return t=e,r[33]=t[0],r[34]=t[1],t})},function(o){return r[35]=r[2].get(r[33]),r[36]=t.i64.to_string(r[35]),r[36]!==void 0?t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[25],r[32]).then(function(e){var t;return t=e,r[37]=t[0],r[38]=t[1],t})},function(n){return r[39]=r[1].get(r[33]),t.forEach(t.filter(t.db.table(16).fetch([[[r[7],e[0],r[37]]]]),function(n){return t.i64.eq(n.threadKey,r[7])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&n.messageId===e[0]&&n.attachmentFbid===r[37]}),function(e){var t=e.update,n=e.item;return t({attachmentFbid:r[36],originalFileHash:r[39]})})}]):t.resolve()}])}):t.resolve()},function(o){return t.storedProcedure(n("LSGetMessageAttributionParams"),e[0]).then(function(e){var t;return t=e,r[27]=t[0],r[28]=t[1],r[29]=t[2],t})},function(o){return t.i64.neq(r[27],void 0)?r[30]=r[27]:r[30]=t.i64.cast([0,0]),t.storedProcedure(n("LSIssueSendAttachmentMessageTask"),r[8],r[7],r[14],e[0],r[9],r[0],r[30],r[10],r[11],r[3],r[16],r[17],e[1],r[22])},function(e){return t.i64.ge(t.i64.cast([0,0]),t.i64.cast([0,0]))?r[31]=void 0:r[31]=t.i64.cast([0,10006]),r[24]=r[31]}]):t.resolve(r[24]=t.i64.cast([0,10005]))},function(e){return r[13]=r[24]}])},function(e){return r[6]=r[13]}])},function(e){return o[0]=r[6]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMediaSendSendPhase1MultiPhotoMessageV2StoredProcedure",e.__tables__=["media_send_jobs","messages","threads","messages_optimistic_context","attachments"],a.exports=e}),null);
__d("LSResumeMediaSendJob",["LSInsertPhase2PendingTask","LSSendPhase1MultiPhotoMessageV2"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=new t.Map,r[1]=new t.Map,r[1].set("main_job_succeeded",!1),r[1].set("resume_failed",!1),r[1].set("error",void 0),r[1].set("running_sub_job_states",r[0]),r[2]=new t.Map,r[2].set("should_transcode",!1),r[2].set("use_double_phase",!1),r[2].set("send_by_server",!1),r[2].set("is_secure",!1),r[2].set("should_dedupe",!1),r[2].set("is_optimistic_upload",!1),t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["state","ASC"]]).next().then(function(e,t){var n=e.done,o=e.value;return n?0:(t=o.item,r[2].set("should_transcode",t.shouldTranscode),r[2].set("use_double_phase",t.useDoublePhase),r[2].set("send_by_server",t.sendByServer),r[2].set("is_secure",t.isSecure),r[2].set("is_optimistic_upload",!1))})},function(n){return r[4]=new t.Map,t.forEach(t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["inMessageIndex","ASC"]]),function(e){var n=e.item;return r[13]=n.offlineAttachmentId,r[11]=n.state,r[12]=n.error,t.i64.eq(r[11],t.i64.cast([-1,4294967293]))?r[10]=!0:(t.i64.eq(r[11],t.i64.cast([0,1]))?r[14]=!0:(t.i64.eq(r[11],t.i64.cast([0,3]))?r[15]=!0:(t.i64.eq(r[11],t.i64.cast([0,5]))?r[16]=!0:(t.i64.eq(r[11],t.i64.cast([0,13]))?r[17]=!0:(t.i64.eq(r[11],t.i64.cast([0,7]))?r[18]=!0:(t.i64.eq(r[11],t.i64.cast([0,9]))?r[19]=!0:(t.i64.eq(r[11],t.i64.cast([0,11]))?r[20]=!0:r[20]=!1,r[19]=r[20]),r[18]=r[19]),r[17]=r[18]),r[16]=r[17]),r[15]=r[16]),r[14]=r[15]),r[10]=r[14]),r[10]?t.resolve(t.i64.eq(r[11],t.i64.cast([0,5]))||t.i64.eq(r[11],t.i64.cast([0,11]))?0:r[4].set(r[13],r[11])):t.i64.neq(r[12],void 0)?t.resolve((r[1].set("resume_failed",!0),r[1].set("error",r[12]))):(t.i64.eq(r[11],t.i64.cast([-1,4294967295]))?r[14]=t.i64.cast([0,5]):(t.i64.eq(r[11],t.i64.cast([-1,4294967294]))?(r[16]=r[2].get("should_transcode"),r[15]=r[16]?t.i64.cast([0,1]):t.i64.cast([0,3])):(t.i64.eq(r[11],t.i64.cast([0,2]))?r[16]=t.i64.cast([0,3]):(t.i64.eq(r[11],t.i64.cast([0,4]))?(r[18]=r[2].get("send_by_server"),r[19]=r[2].get("use_double_phase"),r[17]=r[18]?r[19]?t.i64.cast([0,13]):void 0:t.i64.cast([0,5])):(t.i64.eq(r[11],t.i64.cast([0,6]))?(r[19]=r[2].get("use_double_phase"),r[18]=r[19]?t.i64.cast([0,13]):void 0):(t.i64.eq(r[11],t.i64.cast([0,14]))?(r[20]=r[2].get("use_double_phase"),r[21]=r[2].get("should_transcode"),r[19]=r[20]?r[21]?t.i64.cast([0,7]):t.i64.cast([0,9]):void 0):(t.i64.eq(r[11],t.i64.cast([0,8]))?r[20]=t.i64.cast([0,9]):(t.i64.eq(r[11],t.i64.cast([0,10]))?(r[22]=r[2].get("send_by_server"),r[21]=r[22]?void 0:t.i64.cast([0,11])):(t.i64.eq(r[11],t.i64.cast([0,12])),r[22]=void 0,r[21]=r[22]),r[20]=r[21]),r[19]=r[20]),r[18]=r[19]),r[17]=r[18]),r[16]=r[17]),r[15]=r[16]),r[14]=r[15]),t.i64.neq(r[14],void 0)?t.sequence([function(e){return t.forEach(t.db.table(51).fetch([[[r[13]]]]),function(e){var t=e.update,n=e.item;return t({state:r[14]})})},function(e){return t.i64.eq(r[14],t.i64.cast([0,5]))||t.i64.eq(r[14],t.i64.cast([0,11]))?0:r[4].set(r[13],r[14])}]):t.resolve())})},function(n){return t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["state","ASC"]]).next().then(function(e,t){var n=e.done,o=e.value;return n?r[5]=void 0:(t=o.item,r[5]=t.state)})},function(o){return t.i64.neq(r[5],void 0)?(r[10]=r[2].get("send_by_server"),r[11]=r[2].get("use_double_phase"),r[12]=r[2].get("use_double_phase"),(r[10]?r[11]?t.i64.eq(r[5],t.i64.cast([0,10])):t.i64.eq(r[5],t.i64.cast([0,4])):r[12]?t.i64.eq(r[5],t.i64.cast([0,12])):t.i64.eq(r[5],t.i64.cast([0,6])))?t.resolve(r[1].set("main_job_succeeded",!0)):t.i64.eq(r[5],t.i64.cast([0,5]))?t.sequence([function(n){return r[13]=void 0,t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var n=e.item;return r[15]=n.error,t.i64.eq(r[15],void 0)?(t.i64.neq(n.fbid,void 0)?r[16]=void 0:r[16]=t.i64.cast([0,9]),r[14]=r[16]):r[14]=r[15],t.i64.neq(r[14],void 0)?r[13]=r[14]:0})},function(o){return t.i64.neq(r[13],void 0)?t.resolve((r[1].set("resume_failed",!0),r[1].set("error",r[13]))):(r[14]=r[2].get("is_optimistic_upload"),r[14]?(r[15]=r[2].get("send_by_server"),r[16]=r[2].get("use_double_phase"),r[17]=r[2].get("use_double_phase"),(r[15]?r[16]?t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,10])):t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,4])):r[17]?t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,12])):t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,6])))?t.resolve(r[1].set("main_job_succeeded",!0)):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([-1,4294967295]))?r[18]=t.i64.cast([0,5]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([-1,4294967294]))?(r[20]=r[2].get("should_transcode"),r[19]=r[20]?t.i64.cast([0,1]):t.i64.cast([0,3])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,2]))?r[20]=t.i64.cast([0,3]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,4]))?(r[22]=r[2].get("send_by_server"),r[23]=r[2].get("use_double_phase"),r[21]=r[22]?r[23]?t.i64.cast([0,13]):void 0:t.i64.cast([0,5])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,6]))?(r[23]=r[2].get("use_double_phase"),r[22]=r[23]?t.i64.cast([0,13]):void 0):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,14]))?(r[24]=r[2].get("use_double_phase"),r[25]=r[2].get("should_transcode"),r[23]=r[24]?r[25]?t.i64.cast([0,7]):t.i64.cast([0,9]):void 0):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,8]))?r[24]=t.i64.cast([0,9]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,10]))?(r[26]=r[2].get("send_by_server"),r[25]=r[26]?void 0:t.i64.cast([0,11])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,12])),r[26]=void 0,r[25]=r[26]),r[24]=r[25]),r[23]=r[24]),r[22]=r[23]),r[21]=r[22]),r[20]=r[21]),r[19]=r[20]),r[18]=r[19]),t.i64.neq(r[18],void 0)?t.sequence([function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var t=e.update,n=e.item;return t({state:r[18]})})},function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var t=e.item;return r[4].set(t.offlineAttachmentId,t.state)})}]):t.resolve())):t.sequence([function(o){return r[15]=r[2].get("is_secure"),r[15]?t.sequence([function(n){return r[17]=t.createArray(),r[18]=new t.Map,r[19]=new t.Map,r[20]=!1,r[21]=t.i64.cast([0,0]),t.forEach(t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["inMessageIndex","ASC"]]),function(e){var n=e.item;return r[26]=n.fbid,r[21]=t.i64.add(r[21],t.i64.cast([0,1])),t.i64.neq(r[26],void 0)?r[27]=(r[17].push(r[26]),r[17]):0})},function(n){return r[22]=t.createArray(),t.forEach(t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["inMessageIndex","ASC"]]),function(e){var t=e.item;return r[26]=t.metadata,r[26]!==void 0?r[27]=(r[22].push(r[26]),r[22]):0})},function(e){return r[23]=t.i64.of_int32(r[17].length),r[24]=t.i64.of_int32(r[22].length),t.i64.neq(r[23],r[21])||t.i64.neq(r[24],r[21])?r[25]=t.i64.cast([0,11]):((function(e){t.logger(e).debug(e)})("[TincanLS][LSSecureMailboxSendSecureMediaMessageStoredProcedure] Started"),(function(e){t.logger(e).debug(e)})("[TincanLS][LSSecureMailboxSendSecureMediaMessageStoredProcedure] Completed"),r[25]=void 0),r[16]=r[25]}]):t.sequence([function(o){return t.storedProcedure(n("LSSendPhase1MultiPhotoMessageV2"),e[0],e[2]).then(function(e){var t;return t=e,r[17]=t[0],t})},function(n){return t.i64.eq(r[17],void 0)?t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var n=e.update,r=e.item;return n({state:t.i64.cast([0,6])})}):t.resolve()},function(e){return r[16]=r[17]}])},function(n){return t.i64.eq(r[16],void 0)?(r[17]=r[2].get("send_by_server"),r[18]=r[2].get("use_double_phase"),r[19]=r[2].get("use_double_phase"),(r[17]?r[18]?t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,10])):t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,4])):r[19]?t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,12])):t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,6])))?t.resolve(r[1].set("main_job_succeeded",!0)):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([-1,4294967295]))?r[20]=t.i64.cast([0,5]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([-1,4294967294]))?(r[22]=r[2].get("should_transcode"),r[21]=r[22]?t.i64.cast([0,1]):t.i64.cast([0,3])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,2]))?r[22]=t.i64.cast([0,3]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,4]))?(r[24]=r[2].get("send_by_server"),r[25]=r[2].get("use_double_phase"),r[23]=r[24]?r[25]?t.i64.cast([0,13]):void 0:t.i64.cast([0,5])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,6]))?(r[25]=r[2].get("use_double_phase"),r[24]=r[25]?t.i64.cast([0,13]):void 0):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,14]))?(r[26]=r[2].get("use_double_phase"),r[27]=r[2].get("should_transcode"),r[25]=r[26]?r[27]?t.i64.cast([0,7]):t.i64.cast([0,9]):void 0):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,8]))?r[26]=t.i64.cast([0,9]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,10]))?(r[28]=r[2].get("send_by_server"),r[27]=r[28]?void 0:t.i64.cast([0,11])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,12])),r[28]=void 0,r[27]=r[28]),r[26]=r[27]),r[25]=r[26]),r[24]=r[25]),r[23]=r[24]),r[22]=r[23]),r[21]=r[22]),r[20]=r[21]),t.i64.neq(r[20],void 0)?t.sequence([function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var t=e.update,n=e.item;return t({state:r[20]})})},function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var t=e.item;return r[4].set(t.offlineAttachmentId,t.state)})}]):t.resolve())):t.resolve((r[1].set("resume_failed",!0),r[1].set("error",r[16])))}]))}]):t.i64.eq(r[5],t.i64.cast([0,11]))?t.sequence([function(n){return r[13]=void 0,t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var n=e.item;return r[14]=n.error,t.i64.neq(r[14],void 0)?r[13]=r[14]:0})},function(e){return t.i64.neq(r[13],void 0)?(r[1].set("resume_failed",!0),r[1].set("error",r[13])):r[1].set("main_job_succeeded",!0)}]):t.i64.eq(r[5],t.i64.cast([0,13]))?t.sequence([function(o){return t.storedProcedure(n("LSInsertPhase2PendingTask"),e[0],e[1]).then(function(e){var t;return t=e,r[13]=t[0],t})},function(n){return t.i64.neq(r[13],void 0)?t.resolve((r[1].set("resume_failed",!0),r[1].set("error",r[13]))):t.sequence([function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var n=e.update,r=e.item;return n({state:t.i64.cast([0,14])})})},function(n){return r[1].set("main_job_succeeded",!0),t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var t=e.item;return r[4].set(t.offlineAttachmentId,t.state)})}])}]):t.resolve(0)):t.resolve((r[1].set("resume_failed",!0),r[1].set("error",t.i64.cast([0,11]))))},function(e){var t;return r[7]=r[1].get("main_job_succeeded"),r[8]=r[1].get("resume_failed"),r[9]=r[1].get("error"),t=[r[7],r[8],r[9],r[4]],o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMediaSendResumeMediaSendJobStoredProcedure",e.__tables__=["media_send_jobs"],a.exports=e}),null);
__d("LSResumeMediaSendJobStoredProcedure",["LSResumeMediaSendJob","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSResumeMediaSendJob"),a.jobId,a.pluginType,a.dataTraceId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MAWCreateOneToOneThread",["FBLogger","I64","LSAuthorityLevel","LSFactory","LSIntEnum","MAWBridgeSendAndReceive","MAWHandleActThread","MAWJids","MAWMiActMappingTableAPI","MAWThreadLoadingState","MAWThreadMappingQPL","MAWVerifyThreadExistsUtils","Promise","QPLUserFlow","WMIWABridgeApi","asyncToGeneratorRuntime","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=["instanceKey"],s,u,c;function d(e,t,n,r){if(t!=null)return t;var a=n!=null?(u||(u=o("I64"))).of_string(n):void 0,i=o("MAWThreadMappingQPL").getInstanceKeyForThreadKey(a!=null?a:(u||(u=o("I64"))).zero);return o("MAWThreadMappingQPL").start({instanceKey:i,jid:e,threadKey:a,trigger:"MAWCreateOneToOneThread_"+r}),i}function m(e,t,n){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=yield o("MAWVerifyThreadExistsUtils").runVerifyThreadExistsSproc(r("LSFactory")(e),{authorityLevel:(c||(c=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").OPTIMISTIC),threadType:c.ofNumber(15)},"MAWCreateOneToOneThread"),i=a[0];if(r("gkx")("17734")){var l=yield e.threads.get(i);l==null?r("FBLogger")("maw_one_to_one_thread_creation").mustfix("No thread written to threads table"):yield e.threads.upsert([i],babelHelpers.extends({},l,{clientThreadKey:i}))}var s=yield R(e,t);return s===!0&&(o("MAWThreadMappingQPL").addPoint("insert_placeholder_mapping_row",n),yield o("MAWThreadLoadingState").markActThreadLoadingAsInProgress(e,i,o("MAWJids").convertChatJidToIntJid(t))),(u||(u=o("I64"))).to_string(i)}),p.apply(this,arguments)}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.db,r=e.description,a=e.existingInstanceKey,l=e.jid,u=e.optimisticThreadKey,c=yield C(t.tables,l);if(c!=null)return{skippedOrFailedResult:babelHelpers.extends({},c,{jid:l})};var p=d(l,a,u,r),_=t.runInTransaction(function(e){return m(e,l,p)},"readwrite",void 0,void 0,i.id+":159"),f=yield u!=null?(s||(s=n("Promise"))).resolve(u):o("MAWThreadMappingQPL").measurePerformance("running_verify_thread_exists",p,function(){return _});return{instanceKey:p,passedOptimisticThreadKey:f}}),f.apply(this,arguments)}function g(e){var t=e.db,r=e.description,a=e.existingInstanceKey,l=e.jid,u=e.optimisticThreadKey;return t.runInTransaction((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield C(e,l);if(t!=null)return{skippedOrFailedResult:babelHelpers.extends({},t,{jid:l})};var i=d(l,a,u,r),c=yield u!=null?(s||(s=n("Promise"))).resolve(u):o("MAWThreadMappingQPL").measurePerformance("running_verify_thread_exists",i,function(){return m(e,l,i)});return{instanceKey:i,passedOptimisticThreadKey:c}});return function(t){return e.apply(this,arguments)}})(),"readwrite",void 0,void 0,i.id+":182").catch(function(){return{skippedOrFailedResult:{isCreated:!1,jid:l}}})}function h(e,t,n,r,o,a){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,a,i,l,c){var d=o("MAWJids").convertIntJidToOneToOneChatJid(t),m={db:e,description:i,existingInstanceKey:c,jid:d,optimisticThreadKey:a},p=yield r("gkx")("17734")?g(m):_(m);if(p.skippedOrFailedResult!=null)return p.skippedOrFailedResult;var f=p.instanceKey,h=p.passedOptimisticThreadKey,y=(u||(u=o("I64"))).to_string(t),C=function(a){l!=null&&r("QPLUserFlow").addPoint(r("qpl")._(25313175,"1551"),"verify-e2ee-metadata-thread-exists-end",{instanceKey:l});var t={contactFbid:y,description:i,instanceKey:f,s2sInstanceKey:l,threadKey:a},u=S(e,d,i,t);return(s||(s=n("Promise"))).all([u,r("WMIWABridgeApi").getDevices({ignoreDhash:!1,reason:"creating-1-1-thread: "+i,users:new Set().add(o("MAWJids").toUserJid(y))})]).then(function(e){var t=e[0].isCreated;return t})};return C(h).then(function(e){return{isCreated:e,jid:d}})}),y.apply(this,arguments)}function C(e,t){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield o("MAWThreadLoadingState").genLoadingStateFromJid(e,t);if(n.miState!==o("MAWThreadLoadingState").MiState.MISSING)return{isCreated:!1}}),b.apply(this,arguments)}function v(e,t,n){return o("MAWMiActMappingTableAPI").getMappingRowForChatJid(e,n).then(function(r){return r!=null&&o("MAWThreadLoadingState").markActThreadLoadingAsCompletedForJid(e,{jid:n,threadKey:(u||(u=o("I64"))).of_string(t)})})}function S(t,n,r,a){var l=a.instanceKey,s=babelHelpers.objectWithoutPropertiesLoose(a,e);return o("MAWThreadMappingQPL").measurePerformance("maw_create_thread",l,function(){return o("MAWBridgeSendAndReceive").sendAndReceive("backend","createOrUpdateThread",s)}).then(function(e){var a=e.created;return t.runInTransaction(function(e){return o("MAWHandleActThread").handleActThreadWhenOptimisticInMI(e,{description:r,instanceKey:l,jid:n,optimisticThreadKey:s.threadKey}).then(function(){return v(e,s.threadKey,n).then(function(){return{isCreated:a}})})},"readwrite",void 0,void 0,i.id+":337")})}function R(e,t){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield o("MAWMiActMappingTableAPI").getMappingRowForChatJid(e,t);return n==null}),L.apply(this,arguments)}l.call=h}),98);
__d("ResumableUploadServiceState.enum",[],(function(t,n,r,o,a,i){"use strict";var e=Object.freeze({CANCEL:"upload-cancel",FAIL:"upload-fail",FILE_TOO_LARGE:"upload-too-large",NOT_STARTED:"upload-not-started",PROGRESS:"upload-progress",START:"upload-start",SUCCESS:"upload-success",TRANSPORT_FAILURE:"upload-transport-fail"});i.default=e}),66);
__d("MWPComposerMediaUploadUtil",["FileMercuryUploadService","I64","LSGetAttachmentType","LSIntEnum","MessagingAttachmentType","Promise","ResumableUploadServiceState.enum","URI","asyncToGeneratorRuntime","cr:7187","emptyFunction","gkx","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="messenger_file",m="messenger_audio",p="messenger_image",_="messenger_video",f="file_type",g="image_type",h="video_type",y="audio_type",C="FILE_ATTACHMENT",b="VOICE_MESSAGE",v="target_id";function S(e,t,a,i,l,s){if(a===void 0&&(a=r("emptyFunction")),!!n("cr:7187")){var S=(c||(c=r("URI"))).getRequestURI().getDomain(),R=/workplace.com/i.test(S)?"workplace.com":/messenger.com/i.test(S)?"messenger.com":"facebook.com";i.forEach(function(i,c){var S,L=i.attachmentType,E=i.file,k=d,I=f,T=C;switch(L){case(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").IMAGE):k=p,I=g;break;case(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").AUDIO):k=m,I=y,T=b;break;case(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").VIDEO):k=_,I=h;break;default:break}var D=n("cr:7187").create({consumer:k,customHttpHeaders:new Map([[v,s],[I,T]]),serviceDomain:R});D.addListener((S=r("ResumableUploadServiceState.enum")).START,function(){e&&e(l[c],E.size,E.type)}),D.addListener(S.SUCCESS,function(e){t(l[c],e.media_id)}),D.addListener(S.FAIL,function(e){a(l[c],{response:e})}),D.addListener(S.TRANSPORT_FAILURE,function(e){a(l[c],{response:e})}),D.resume(E)})}}function R(e,t,n,r,o,a,i,l,s,u,c,d,m){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a,i,l,c,d,m,p,_,f,g,h,y){if(a===void 0&&(a=r("emptyFunction")),l===void 0&&(l=r("emptyFunction")),c===void 0&&(c=!1),n("cr:7187")&&h!=null&&p!==!0){var C=[],b=[],v=[],R=[],L=yield(e||(e=n("Promise"))).all(d.map(function(e){return o("LSGetAttachmentType").LSGetAttachmentType(e)}));d.forEach(function(e,t){var n=L[t];(s||(s=o("I64"))).equal(n,(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").VIDEO))?(C.push({attachmentType:n,file:e}),b.push(m[t])):(v.push(e),R.push(m[t]))}),C.length>0&&S(t,i,l,C,b,h),v.length>0&&r("promiseDone")(o("FileMercuryUploadService").uploadByMercuryUploadService({chatSupportUserId:_,chatSupportUserNonce:g,files:v,isChatSupportUser:p,isVoiceClip:c,onUploadFailure:l,onUploadProgress:a,onUploadStart:t,onUploadSuccess:i,uploadIDs:R,uploadIdToQplFlow:y,voiceClipWaveformData:f}))}else r("promiseDone")(o("FileMercuryUploadService").uploadByMercuryUploadService({chatSupportUserId:_,chatSupportUserNonce:g,files:d,isChatSupportUser:p,isVoiceClip:c,onUploadFailure:l,onUploadProgress:a,onUploadStart:t,onUploadSuccess:i,uploadIDs:m,uploadIdToQplFlow:y,voiceClipWaveformData:f}))}),L.apply(this,arguments)}function E(e,t,n,a){var i;return{action_url:void 0,attachment_fbid:e,attachment_index:(s||(s=o("I64"))).zero,attachment_type:(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").AUDIO),cta1_title:void 0,cta2_title:void 0,cta3_title:void 0,description_text:void 0,filename:void 0,filesize:void 0,has_media:!0,has_xma:!1,image_url:void 0,mini_preview:void 0,offline_attachment_id:e,original_file_hash:void 0,playable_duration_ms:s.of_float(n*1e3),playable_url:URL.createObjectURL(t),playable_url_mime_type:t.type,preview_height:void 0,preview_url:void 0,preview_url_mime_type:void 0,preview_width:void 0,sampling_frequency_hz:a==null?void 0:a.sampling_freq,source_text:void 0,subtitle_text:void 0,title_text:void 0,waveform_data:a==null||(i=a.amplitudes)==null?void 0:i.join(","),xma_layout_type:void 0,xmas_template_type:void 0}}function k(e,t,n){var a=e.map(function(e){return{action_url:void 0,attachment_fbid:e.offlineAttachmentId,attachment_index:(s||(s=o("I64"))).zero,attachment_type:e.attachmentType,cta1_title:void 0,cta2_title:void 0,cta3_title:void 0,description_text:void 0,filename:e.filename,filesize:void 0,has_media:!0,has_xma:!1,image_url:void 0,mini_preview:void 0,offline_attachment_id:e.offlineAttachmentId,original_file_hash:void 0,playable_duration_ms:void 0,playable_url:e.previewUrl,playable_url_mime_type:e.mimeType,preview_height:e.previewHeight,preview_url:e.previewUrl,preview_url_mime_type:void 0,preview_width:e.previewWidth,source_text:void 0,subtitle_text:void 0,title_text:void 0,xma_layout_type:void 0,xmas_template_type:void 0}}),i=[],l=[];return a.forEach(function(e){((s||(s=o("I64"))).equal(e.attachment_type,(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").IMAGE))||r("gkx")("4280")&&(s||(s=o("I64"))).equal(e.attachment_type,(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").VIDEO)))&&!t?(l.push(e),n===!0&&l.length===30&&(i.unshift([].concat(l)),l.length=0)):i.push([e])}),l.length>0&&(n===!0?i.push(l):i.unshift(l)),i.map(function(e){return e.map(function(e,t){return babelHelpers.extends({},e,{attachment_index:(s||(s=o("I64"))).of_int32(t)})})})}l.startUpload=R,l.getAudioAttachment=E,l.createPartitionedAttachments=k}),98);
__d("MWPOpenComposerUtils",["I64","LSRemoveMediaSendJobsStoredProcedure","LSResumeMediaSendJobStoredProcedure","MWConsole","Promise","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){return e.media_staging.get(t).then(function(r){return r!=null?e.media_staging.delete(t):(s||(s=n("Promise"))).resolve()})}function c(e,t,n){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=yield e.media_staging.get(t);r!=null&&(yield e.media_staging.put(n(r)))}),d.apply(this,arguments)}function m(e,t,r,o,a){return e.attachments.get(t,r,o).then(function(i){return i!=null?e.attachments.upsert([t,r,o],a(i)):(s||(s=n("Promise"))).resolve()})}function p(t,a,i){return r("LSResumeMediaSendJobStoredProcedure")(t,{dataTraceId:i!=null?i:void 0,jobId:a,pluginType:(e||(e=o("I64"))).zero}).then(function(e){var o=e[0],i=e[1],l=e[2];return o?r("LSRemoveMediaSendJobsStoredProcedure")(t,{offlineThreadingId:a}):(s||(s=n("Promise"))).resolve()})}l.deleteMediaStaging=u,l.updateMediaStaging=c,l.updateAttachment=m,l.resumeSendJob=p}),98);
__d("WebWorker",["invariant","BlobFactory","Bootloader","EventListener","FBLogger","SubscriptionsHandler","TrustedTypesWebWorkerScriptURLPolicy","URI","WebWorkerConfig","XCometFBMultiSiteWebWorkerInitScriptControllerRouteBuilder","XHRRequest","cr:951783","emptyFunction","err","filterObject","getCrossOriginTransport","getWorkerInitScriptSPINParams","gkx","isSameOrigin","justknobx","memoize","nullthrows","performanceNow"],(function(t,n,r,o,a,i,l){var e,s,u=t.URL||t.webkitURL,c={remove:n("emptyFunction")},d=(function(){"use strict";function r(e){var t=this;this.$2=!1,this.$3=null,this.$4=e,this.__worker=null,this.$5=n("emptyFunction"),this.$6=n("emptyFunction"),this.$7=[],this.$8=[],this.$9=!1,this.$10=new(n("SubscriptionsHandler")),this.$1=n("cr:951783")!==null?n("cr:951783")(function(){t.$9||t.terminate()}):c,n("gkx")("20935")&&setTimeout(function(){!t.$9&&!t.isCurrentState("terminated")&&n("FBLogger")("comet_infra").mustfix("WebWorker (resource: %s) allowCrossPageTransitions must be true on Comet, or you must handle cleaning up your worker.",e.name)},1e3),this.$11("constructed")}var o=r.prototype;return o.setMessageHandler=function(t){return this.$5=t||n("emptyFunction"),this},o.setErrorHandler=function(t){return this.$6=t||n("emptyFunction"),this},o.postMessage=function(t,n){if(!this.isCurrentState("constructed")||l(0,5977),!this.isCurrentState("terminated")||l(0,5978),this.isCurrentState("preparing"))return this.$7.push(this.postMessage.bind(this,t,n)),this;var e={type:"message",message:t};return n?this.getInterfaceableWorker().postMessage(e,n):this.getInterfaceableWorker().postMessage(e),this},o.$12=function(){this.isCurrentState("terminated")||(this.$11("terminated"),this.__worker=null,this.$13(),this.$7=[],this.$8=[],this.$1&&this.$1.remove&&this.$1.remove())},o.terminate=function(){this.isCurrentState("executing")&&this.__worker!=null&&this.__worker.terminate(),this.$12()},o.execute=function(){var e=this;!this.isCurrentState("terminated")||l(0,5979);var t=["preparing","executing"];return t.some(function(t){return e.isCurrentState(t)})?this:(this.$11("preparing"),r.prepareResource(this.$4,this.$14.bind(this)),this)},o.setAllowCrossPageTransition=function(t){return n("gkx")("20935")&&!t&&n("FBLogger")("comet_infra").mustfix("allowAcrossPageTransitions must be true because we dont kill these in Comet."),this.$9=t,this},o.isCurrentState=function(t){return r.states.includes(t)||l(0,5980,t),t===this.$3},o.$14=function(){if(!this.isCurrentState("executing")||l(0,5981),!this.isCurrentState("terminated")){if(this.$4.useInitScript&&n("gkx")("21112")||this.$4.sameOriginURL||this.$4.source||l(0,19837,this.$4.name),this.$4.useInitScript&&n("gkx")("21112")){var e,t=n("nullthrows")((e=n("XCometFBMultiSiteWebWorkerInitScriptControllerRouteBuilder").buildUri({}).addQueryParams(n("getWorkerInitScriptSPINParams")()))==null?void 0:e.toString()),o=new window.URL(this.$4.url,window.location.href).href;if(o==null)throw n("err")("Can't start up worker without a resource url.");this.__worker=this.constructWorker(t,this.$4.name),this.__worker.postMessage({bundleUrl:o,doNotStartBundle:!0,isDev:!1,resource:this.$4,type:"sr-init"})}else this.$4.sameOriginURL?this.__worker=this.constructWorker(this.$4.sameOriginURL):(this.__worker=this.constructWorker(r.evalWorkerURL),this.getInterfaceableWorker().postMessage(this.$4.source));if(this.$15("ping",Date.now()),this.$4.dynamicModules)try{this.$15("defineModules",this.$4.dynamicModules)}catch(e){throw this.terminate(),this.$16("define_error",{message:e.message}),e}this.$17(),this.$11("executing"),this.$7.forEach(function(e){return e()}),this.$7=[],this.$8.forEach(function(e){return e()}),this.$8=[]}},o.$13=function(){this.$10.release()},o.$15=function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];this.getInterfaceableWorker().postMessage({type:t,args:n})},o.$16=function(t,o){var e=!(this.$4.useInitScript&&n("gkx")("21112"));r.$16(t,this.$4.name,babelHelpers.extends({},o,{cross_page_transition:!!this.$9,state:this.$3}),e)},r.$18=function(t){return Object.keys(n("filterObject")({object_url:t&&r.$19(),data_url:t&&r.$20(),worker:r.isSupported()},function(e){return!!e}))},o.$17=function(){this.$10.addSubscriptions(n("EventListener").listen(this.getInterfaceableWorker(),"message",this.$21.bind(this)),n("EventListener").listen(this.getInterfaceableWorker(),"error",this.$22.bind(this)))},o.$22=function(t){var e=this.$6(t);!e&&!t.defaultPrevented&&this.$16("exception",{message:t.message})},o.$21=function(n){var e=n.data;switch(e.type){case"message":this.$5(e.message);break;case"pong":this.$2=!0,this.$16("executed",{dt:Math.floor(e.args[1]-e.args[0]),bytes:this.$4.source?this.$4.source.length:-1});break;case"terminate":this.terminate();break;case"haste-error":this.terminate(),this.$16("haste_error",{message:e.message});break;case"console":var r=e.args.shift();["log","error","info","debug","warn"].includes(r)||l(0,5983,r),t.console[r].apply(t.console,e.args);break}},o.$11=function(t){r.states.includes(t)||l(0,5984,t),this.$16("transition",{next_state:t}),this.$3=t},r.prepareResource=function(a,i){if(i===void 0&&(i=n("emptyFunction")),a.sameOriginURL||a.url||a.source||l(0,5985),r.isSupported()||l(0,5986),a.sameOriginURL)i();else if(a.url&&n("isSameOrigin")(new(e||(e=n("URI")))(a.url),new(e||(e=n("URI")))(t.location.href)))a.sameOriginURL=a.url,i();else if(a.source)n("justknobx")._("819")&&n("FBLogger")("static_resources").warn("trying to instantiate blob/data Url Worker %s %s",a.name,a.url),r.$23()&&(a.sameOriginURL=r.$24(a.source)),i();else if(n("gkx")("21112")&&a.useInitScript===!0)i();else if(n("justknobx")._("819")&&n("FBLogger")("static_resources").warn("trying to instantiate blob/data Url Worker %s %s",a.name,a.url),a.loading)a.loading.push(i);else{var o=(s||(s=n("performanceNow")))();a.loading=[i],r.$25(a.url,function(e){e?(a.source=e,r.$23()&&(a.sameOriginURL=r.$24(e)),r.$16("prepared",a.name,{dt:Math.floor((s||(s=n("performanceNow")))()-o),bytes:e.length},!1)):r.$16("failed",a.name,{dt:Math.floor((s||(s=n("performanceNow")))()-o),bytes:0},!1),a.loading.forEach(function(e){return e()}),a.loading=!1})}return a},r.releaseResource=function(t){return t.sameOriginURL.indexOf("blob:")===0&&(u.revokeObjectURL&&u.revokeObjectURL(t.sameOriginURL),t.sameOriginURL=null),t},r.isSupported=function(){return f},r.isMessageChannelSupported=function(){return r.areTransferablesSupported()&&!!t.MessageChannel},r.areTransferablesSupported=function(){return r.isSupported()&&g()},r.$25=function(t,r){new(n("XHRRequest"))(t).setTransportBuilder(n("getCrossOriginTransport")).setMethod("GET").setResponseHandler(function(e){r(e)}).setErrorHandler(r.bind(null,null)).send()},r.$24=function(t){if(r.$23()||l(0,5987),r.$19()){var e=n("BlobFactory").getBlob([t],{type:"application/javascript"});return u.createObjectURL(e)}if(r.$20())return"data:application/javascript,"+encodeURIComponent(t)},r.$19=function(){return n("BlobFactory").isSupported()&&p()},r.$20=function(){return _()},r.$23=function(){return r.$19()||r.$20()},r.$16=function(t,o,a,i){n("WebWorkerConfig").logging.enabled&&n("Bootloader").loadModules(["BanzaiLogger"],function(e){e.log(n("WebWorkerConfig").logging.config,babelHelpers.extends({},a,{features_array:r.$18(i),event:t,resource:o}))},"WebWorker")},o.constructWorker=function(t,n){return m(t,n)},o.$26=function(t,n){if(this.isCurrentState("preparing")){this.$8.push(this.$26.bind(this,t,n));return}this.getInterfaceableWorker().postMessage({type:"port",message:t},n)},o.createMessageChannel=function(t,n){var e=new MessageChannel;return this.$26(t,[e.port2].concat(n||[])),e.port1.start(),e.port1},o.getInterfaceableWorker=function(){return this.__worker},r})();d.states=["constructed","preparing","executing","terminated"],d.evalWorkerURL=n("WebWorkerConfig").evalWorkerURL;function m(e,r){return new t.Worker(n("TrustedTypesWebWorkerScriptURLPolicy").createScriptURL(e),r!=null?{name:r}:{})}var p=n("memoize")(function(){var e,t;if(!u||!u.createObjectURL)return!1;try{e=u.createObjectURL(n("BlobFactory").getBlob([""],{type:"application/javascript"}));var r=m(e);r.terminate(),t=!0}catch(e){t=!1}finally{u.revokeObjectURL&&u.revokeObjectURL(e)}return t}),_=n("memoize")(function(){var e;try{var t=m("data:application/javascript,");t.terminate(),e=!0}catch(t){e=!1}return e}),f=!!t.Worker,g=n("memoize")(function(){var e;try{var t=m(d.evalWorkerURL),n=new ArrayBuffer(0);t.postMessage({buffer:n},[n]),t.terminate(),e=!0}catch(t){e=!1}return e});a.exports=d}),null);
__d("useLSMessagingInitiatingSource",["LSIntEnum","LSMessagingInitiatingSource","MWLSThreadDisplayContext"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){var t=o("MWLSThreadDisplayContext").useMWLSThreadDisplayContext();if(t!=null)return t==="Inbox"?(e||(e=o("LSIntEnum"))).ofNumber(r("LSMessagingInitiatingSource").FACEBOOK_INBOX):t==="FullscreenChat"?(e||(e=o("LSIntEnum"))).ofNumber(r("LSMessagingInitiatingSource").FACEBOOK_FULLSCREEN):t==="ChatTab"?(e||(e=o("LSIntEnum"))).ofNumber(r("LSMessagingInitiatingSource").FACEBOOK_CHAT):(e||(e=o("LSIntEnum"))).ofNumber(r("LSMessagingInitiatingSource").ROOMS_SIDE_CHAT)}l.default=s}),98);